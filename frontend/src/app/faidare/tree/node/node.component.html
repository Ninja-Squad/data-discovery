<span
  *ngIf="node.hasVisibleChildren"
  class="expand fa fa-fw fa-chevron-right mr-1"
  role="button"
  tabindex="0"
  (click)="toggleExpanded()"
  [class.expanded]="node.expanded || node.expandedForced"
></span>

<div class="custom-control custom-checkbox d-inline mr-1">
  <input
    #selection
    type="checkbox"
    class="custom-control-input"
    [indeterminate]="node.selectionState === 'INDETERMINATE'"
    [checked]="node.selectionState === 'CHECKED'"
    (change)="toggleSelection(selection.checked)"
    [id]="node.id"
  />
  <label [for]="node.id" class="custom-control-label">
    <span class="sr-only">{{ node.text }}</span>
  </label>
  <span
    class="node-payload"
    [class.matching]="node.matchingFilter"
    [class.highlighted]="node.id === highlightedNodeId"
    role="button"
    tabindex="0"
    (click)="highlight()"
  >
    <ng-container *ngIf="payloadTemplate; else noPayloadTemplate">
      <ng-container *ngTemplateOutlet="payloadTemplate; context: { node: node }"></ng-container>
    </ng-container>
    <ng-template #noPayloadTemplate>{{ node.text }}</ng-template>
  </span>
</div>

<ul
  class="list-unstyled"
  [ngbCollapse]="!(node.hasVisibleChildren && (node.expanded || node.expandedForced))"
>
  <ng-container *ngFor="let childNode of node.children; trackBy: byId">
    <li
      class="ml-4"
      [ngbCollapse]="!(!filtered || childNode.matchingFilter || childNode.hasVisibleChildren)"
    >
      <dd-node
        [node]="childNode"
        [filtered]="filtered"
        [highlightedNodeId]="highlightedNodeId"
        [payloadTemplate]="payloadTemplate"
        [class.ml-4]="!childNode.hasVisibleChildren"
      ></dd-node>
    </li>
  </ng-container>
</ul>
