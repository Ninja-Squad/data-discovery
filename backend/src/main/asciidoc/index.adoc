= RARe REST services documentation
:toc: left
:source-highlighter: highlightjs

== Introduction

This document describes the URLs, parameters, request and response bodies of the various web services of RARe.

The request and response bodies are always JSON. The examples showed here are pretty-printed to make them easier
to read, but they're not in reality. If you're using the services with the command-line, using HTTPie instead
of curl allows automatically pretty-printing the returned JSON.

All examples here use HTTP, and show example with `localhost` as the server, and 8080 as port. To use the
actual deployed web services, you must of course use the actual protocol, host name and port.

Some headers are also removed from the snippets here, to improve readability.

== Harvests

=== Trigger a harvest

Harvesting, i.e. importing resources from JSON files into Elasticsearch, is simply done by copying the JSON
files to the configured `rare.resource-dir` directory, and then sending a POST request, without any body,
to trigger the harvest.

Harvested resources which already exist are updated (they are identified by their `identifier` property).

Note that, to avoid letting anyone trigger a harvest, the endpoints are secured using basic authentication. The
user and the password are configured in the Spring configuration. The following snippets assume the user is
`rare`, and the password is `f01a7031fc17`. If you don't provide the authentication information, or if it's incorrect
you'll get back a response with the status `401 Unauthorized`.

.Request
include::{snippets}/harvests/post/http-request.adoc[]

.Curl
include::{snippets}/harvests/post/curl-request.adoc[]

.HTTPie
include::{snippets}/harvests/post/httpie-request.adoc[]

The response is immediate: the harvesting job is executed asynchronously. It only contains a Location header
containing the URL of the endpoint that you can query to know the status of the harvest. Each triggered harvest
has a unique auto-generated ID, found at the end of the URL.

.Response
include::{snippets}/harvests/post/http-response.adoc[]

=== Get a harvest

You can get a harvest to know if the harvest is finished or not, and to know which files have already been harvested,
and which errors occurred during the harvest. The report is pretty detailed, and tries its best to provide indices,
line and colum numbers as well as error messages allowing to identify what and where the errors are.

Note that files are processed sequentially, and that resources are parsed one by one, using a the Jackson streaming
parser. This allows harvesting enormous files if needed without fearing any memory problem. It also allows
parsing a file even if one of its resources has an error and thus can't be parsed correctly.

.Request
include::{snippets}/harvests/get/http-request.adoc[]

.Path parameters
include::{snippets}/harvests/get/path-parameters.adoc[]

.Curl
include::{snippets}/harvests/get/curl-request.adoc[]

.HTTPie
include::{snippets}/harvests/get/httpie-request.adoc[]

.Response
include::{snippets}/harvests/get/http-response.adoc[]

.Response fields
include::{snippets}/harvests/get/response-fields.adoc[]

=== List harvests

If you lost or forgot the URL of the harvest you have triggered, and want to see how it went, don't panic. You can
send a GET request to list the last 10 harvests that have been triggered.

.Request
include::{snippets}/harvests/list/http-request.adoc[]

.Curl
include::{snippets}/harvests/list/curl-request.adoc[]

.HTTPie
include::{snippets}/harvests/list/httpie-request.adoc[]

.Response
include::{snippets}/harvests/list/http-response.adoc[]

.Response fields
include::{snippets}/harvests/list/response-fields.adoc[]

As you can see, you actually get back a page of results. In the unlikely case you want to know about old harvests,
you can request other pages than the latest one by passing the page as request parameter:

.Request
include::{snippets}/harvests/list2/http-request.adoc[]

.Request parameters
include::{snippets}/harvests/list2/request-parameters.adoc[]

.Curl
include::{snippets}/harvests/list2/curl-request.adoc[]

.HTTPie
include::{snippets}/harvests/list2/httpie-request.adoc[]

== Pillars

=== List pillars

The pillars service is used to list pillars, their database sources, and the number of genetic resources existing for each of them in the database.

.Request
include::{snippets}/pillars/list/http-request.adoc[]

.Curl
include::{snippets}/pillars/list/curl-request.adoc[]

.HTTPie
include::{snippets}/pillars/list/httpie-request.adoc[]

.Response
include::{snippets}/pillars/list/http-response.adoc[]

.Response fields
include::{snippets}/pillars/list/response-fields.adoc[]
